import SoundManager from"./core/sound-manager.js";import ThemeManager from"./core/theme-manager.js";import{openWindow,closeWindow,closeAllWindows,bringToFront,updateDockActiveStates,makeDraggable,makeResizable,setupWindowControls,getActiveWindows,getCurrentZIndex}from"./core/window-manager.js";import{setupTerminal,setupTerminalMobileFix}from"./apps/terminal.js";import{setupContextMenu}from"./ui/context-menu.js";import{showToast}from"./ui/notifications.js";import{BOOT_LOG_MESSAGES,stickyNotesData}from"./config/data.js";const SWIPE_CLOSE_THRESHOLD_Y=80,SWIPE_CLOSE_MAX_X=50,SWIPE_SWITCH_THRESHOLD_X=100,SWIPE_SWITCH_MAX_Y=50,BOOT_LINE_INTERVAL_MS=80,BOOT_FADE_DELAY_MS=500;let currentOS="desktop";function detectOS(){const e=window.innerWidth;return e<=767?"mobile":e<=1024?"tablet":"desktop"}function updateOS(){const e=detectOS();e!==currentOS&&(currentOS=e,closeAllWindows())}function handleAppIconClick(e){if(!e)return;const t=`${e}-window`,n=document.getElementById(t);if(!n)return;if(getActiveWindows().has(t)){parseInt(n.style.zIndex||0)===getCurrentZIndex()?closeWindow(t):openWindow(e,currentOS)}else openWindow(e,currentOS)}function setupAppIcons(){document.querySelectorAll(".app-icon").forEach(e=>{e.addEventListener("click",t=>{t.preventDefault();handleAppIconClick(e.dataset.app)})});document.querySelectorAll(".dock-item").forEach(e=>{e.addEventListener("click",t=>{t.preventDefault();const n=e.dataset.app;n&&handleAppIconClick(n)})})}function setupMobileGestures(){if("desktop"===currentOS)return;let e=0,t=0,n=null;document.querySelectorAll(".window-header").forEach(o=>{o.addEventListener("touchstart",s=>{e=s.touches[0].clientY,t=s.touches[0].clientX,n=o.closest(".window")},{passive:!0}),o.addEventListener("touchend",o=>{if(!n)return;const s=o.changedTouches[0].clientY,i=o.changedTouches[0].clientX,r=s-e,c=i-t;if(r>80&&Math.abs(c)<50)closeWindow(n.id);else if(Math.abs(c)>100&&Math.abs(r)<50){const e=getActiveWindows(),t=Array.from(e);if(t.length<=1)return;const o=t.indexOf(n.id);let s;s=c>0?o>0?o-1:t.length-1:o<t.length-1?o+1:0;const i=t[s],r=document.getElementById(i);r&&bringToFront(r)}n=null},{passive:!0})})}function updateClock(){const e=new Date,t=e.getHours(),n=String(e.getMinutes()).padStart(2,"0"),o=t>=12?"PM":"AM",s=t%12||12,i=document.querySelector(".menu-clock");i&&(i.textContent=`${s}:${n} ${o}`);const r=document.querySelector(".status-time");r&&(r.textContent=`${s}:${n}`)}function initBootScreen(){const e=document.getElementById("boot-screen"),t=document.getElementById("boot-log");if(!e||!t)return;let n=0,o=null,s=!1;if(window.matchMedia("(prefers-reduced-motion: reduce)").matches){if(e.remove(),"desktop"===currentOS){const e=document.getElementById("about-window");e&&(e.style.top="15%",e.style.left="120px");const t=document.getElementById("contact-window");t&&(t.style.top="15%",t.style.left="750px"),openWindow("contact",currentOS)}openWindow("about",currentOS)}else document.addEventListener("keydown",r),e.addEventListener("click",r),function e(){if(!s)if(n<BOOT_LOG_MESSAGES.length){const s=BOOT_LOG_MESSAGES[n],i=document.createElement("div");s.startsWith("[ OK ]")?i.innerHTML='<span class="ok">[ OK ]</span>'+s.substring(6):s.startsWith("[")?i.innerHTML='<span class="info">'+s+"</span>":i.textContent=s,t.appendChild(i),t.scrollTop=t.scrollHeight,n++,o=setTimeout(e,80)}else setTimeout(i,500)}();function i(){s||(s=!0,o&&clearTimeout(o),document.removeEventListener("keydown",r),e.removeEventListener("click",r),e.classList.add("fade-out"),setTimeout(()=>{if(e.remove(),"desktop"===currentOS){const e=document.getElementById("about-window");e&&(e.style.top="15%",e.style.left="120px")}openWindow("about",currentOS),"desktop"===currentOS&&setTimeout(()=>{const e=document.getElementById("contact-window");e&&(e.style.top="15%",e.style.left="750px"),openWindow("contact",currentOS)},200);const t=()=>{SoundManager.playStartupDrum(),document.removeEventListener("click",t),document.removeEventListener("keydown",t)};document.addEventListener("click",t,{once:!0}),document.addEventListener("keydown",t,{once:!0})},300))}function r(e){"Shift"!==e.key&&"Control"!==e.key&&"Alt"!==e.key&&"Meta"!==e.key&&i()}}function getNoteKey(e){return e.slice(0,30).replace(/\s+/g,"_")}function createStickyNotes(){if("desktop"!==currentOS)return;const e=document.getElementById("sticky-notes");if(!e)return;let t={};try{t=JSON.parse(localStorage.getItem("stickyNotePositions_v3")||"{}")}catch(e){console.error("Failed to load sticky note positions:",e),t={}}stickyNotesData.forEach(n=>{const o=document.createElement("div");o.className=`sticky-note ${"yellow"!==n.color?n.color:""}`,o.style.transform=`rotate(${n.rotation}deg)`;const s=getNoteKey(n.text),i=t[s];i?(o.style.top=i.top,o.style.left=i.left,o.style.right="auto"):(o.style.right=100-n.x+"%",o.style.top=`${n.y}%`),o.textContent=n.text,o.setAttribute("data-note-key",s),o.setAttribute("role","note"),o.setAttribute("tabindex","0");const r=n.text.substring(0,50)+(n.text.length>50?"...":"");o.setAttribute("aria-label",`Sticky note: ${r}. Use arrow keys to move.`),makeStickyDraggable(o),makeStickyKeyboardAccessible(o),e.appendChild(o)})}function makeStickyDraggable(e){let t=0,n=0,o=0,s=0;function i(i){(i=i||window.event).preventDefault(),t=o-i.clientX,n=s-i.clientY,o=i.clientX,s=i.clientY,e.style.top=e.offsetTop-n+"px",e.style.left=e.offsetLeft-t+"px",e.style.right="auto"}function r(){e.classList.remove("dragging"),e.style.zIndex=50,document.removeEventListener("mouseup",r),document.removeEventListener("mousemove",i);const t=e.getAttribute("data-note-key");if(t){const n=JSON.parse(localStorage.getItem("stickyNotePositions_v3")||"{}");n[t]={top:e.style.top,left:e.style.left},localStorage.setItem("stickyNotePositions_v3",JSON.stringify(n))}}e.addEventListener("mousedown",function(t){t.preventDefault(),o=t.clientX,s=t.clientY,e.classList.add("dragging"),e.style.zIndex=999,document.addEventListener("mouseup",r),document.addEventListener("mousemove",i)})}function makeStickyKeyboardAccessible(e){e.addEventListener("keydown",t=>{if(!["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(t.key))return;t.preventDefault(),e.style.left&&"auto"!==e.style.left||(e.style.left=e.offsetLeft+"px"),e.style.top||(e.style.top=e.offsetTop+"px"),e.style.right="auto";const n=parseInt(e.style.top)||0,o=parseInt(e.style.left)||0;switch(t.key){case"ArrowUp":e.style.top=Math.max(0,n-10)+"px";break;case"ArrowDown":e.style.top=Math.min(window.innerHeight-100,n+10)+"px";break;case"ArrowLeft":e.style.left=Math.max(0,o-10)+"px";break;case"ArrowRight":e.style.left=Math.min(window.innerWidth-100,o+10)+"px"}const s=e.getAttribute("data-note-key");if(s){const t=JSON.parse(localStorage.getItem("stickyNotePositions_v3")||"{}");t[s]={top:e.style.top,left:e.style.left},localStorage.setItem("stickyNotePositions_v3",JSON.stringify(t))}})}function setupParallaxWallpaper(){if("desktop"!==currentOS)return;const e=document.querySelector(".wallpaper");if(!e)return;let t=null;document.addEventListener("mousemove",n=>{t||(t=requestAnimationFrame(()=>{const o=2*(n.clientX/window.innerWidth-.5),s=2*(n.clientY/window.innerHeight-.5);e.style.setProperty("--mouse-x",o.toFixed(3)),e.style.setProperty("--mouse-y",s.toFixed(3)),t=null}))})}function setupNavigationHint(){const e=document.getElementById("nav-hint"),t=document.getElementById("nav-hint-dismiss");if(!e||!t)return;localStorage.getItem("hasSeenNavHint")||"desktop"!==currentOS||setTimeout(()=>{e.classList.add("visible")},4e3),t.addEventListener("click",()=>{e.classList.remove("visible"),localStorage.setItem("hasSeenNavHint","true")}),document.querySelectorAll(".app-icon, .dock-item").forEach(t=>{t.addEventListener("click",()=>{e.classList.contains("visible")&&(e.classList.remove("visible"),localStorage.setItem("hasSeenNavHint","true"))},{once:!0})})}function setupSwipeHint(){if("desktop"===currentOS)return;const e=localStorage.getItem("hasSeenSwipeHint");if(e)return;const t=document.createElement("div");t.className="swipe-hint",t.innerHTML='<i class="fas fa-hand-pointer"></i> Swipe down on window header to close',document.body.appendChild(t);let n=0;document.querySelectorAll(".app-icon, .dock-item").forEach(o=>{o.addEventListener("click",()=>{n++,1!==n||e||setTimeout(()=>{t.classList.add("visible"),setTimeout(()=>{t.classList.remove("visible"),localStorage.setItem("hasSeenSwipeHint","true")},5e3)},1e3)},{once:!0})})}function setupSoundToggle(){const e=document.getElementById("sound-toggle");e&&(e.checked=!SoundManager.isMuted(),e.setAttribute("aria-pressed",!SoundManager.isMuted()),e.addEventListener("change",()=>{const t=!e.checked;SoundManager.setMuted(t),e.setAttribute("aria-pressed",!t),t?showToast("Sound effects muted","fa-volume-mute"):showToast("Sound effects enabled","fa-volume-up")}))}document.addEventListener("DOMContentLoaded",()=>{initBootScreen(),updateOS(),ThemeManager.init(),ThemeManager.setupListeners(),setupAppIcons(),setupWindowControls(),setupTerminal(),setupTerminalMobileFix(),setupSoundToggle(),setupContextMenu(currentOS),setupMobileGestures(),createStickyNotes(),setupParallaxWallpaper(),setupNavigationHint(),setupSwipeHint(),document.querySelectorAll(".window").forEach(e=>{makeDraggable(e,currentOS),makeResizable(e,currentOS),e.addEventListener("mousedown",()=>{bringToFront(e)})}),updateClock();const e=setInterval(updateClock,6e4);window.addEventListener("beforeunload",()=>{clearInterval(e)});let t=null;window.addEventListener("resize",()=>{t&&clearTimeout(t),t=setTimeout(()=>{updateOS(),t=null},300)})});